<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Leads Management</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-content">
                <h1>Dashboard</h1>
                <form action="/logout" method="POST" class="logout-form">
                    <button type="submit" class="logout-btn">Logout</button>
                </form>
            </div>
        </header>
        
        <main class="dashboard-main">
            <div class="dashboard-content">
                <div class="table-header">
                    <div class="header-left">
                        <h2>Leads Management</h2>
                        <p>Total leads: <%= leads.length %></p>
                    </div>
                    <div class="header-right">
                        <div class="filter-container">
                            <label for="statusFilter" class="filter-label">Filter by Status:</label>
                            <select id="statusFilter" class="filter-select" onchange="filterLeads()">
                                <option value="all" <%= currentFilter === 'all' ? 'selected' : '' %>>All Leads</option>
                                <option value="new" <%= currentFilter === 'new' ? 'selected' : '' %>>New</option>
                                <option value="contacted" <%= currentFilter === 'contacted' ? 'selected' : '' %>>Contacted</option>
                                <option value="qualified" <%= currentFilter === 'qualified' ? 'selected' : '' %>>Qualified</option>
                                <option value="proposal" <%= currentFilter === 'proposal' ? 'selected' : '' %>>Proposal</option>
                                <option value="closed" <%= currentFilter === 'closed' ? 'selected' : '' %>>Closed</option>
                                <option value="lost" <%= currentFilter === 'lost' ? 'selected' : '' %>>Lost</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <% if (locals.error) { %>
                    <div class="error-message">
                        <%= error %>
                    </div>
                <% } %>
                
                <% if (leads.length > 0) { %>
                    <div class="table-container">
                        <table class="leads-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Website</th>
                                    <th>Address</th>
                                    <th>Rating</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% leads.forEach(lead => { %>
                                    <tr>
                                        <td class="name-cell"><%= lead.name %></td>
                                        <td class="phone-cell"><%= lead.phone %></td>
                                        <td class="website-cell">
                                            <a href="http://<%= lead.website %>" target="_blank">
                                                <%= lead.website %>
                                            </a>
                                        </td>
                                        <td class="address-cell"><%= lead.address %></td>
                                        <td class="rating-cell">
                                            <span class="rating">‚≠ê <%= lead.rating %></span>
                                        </td>
                                        <td class="status-cell">
                                            <span class="status status-<%= lead.status || 'new' %>">
                                                <%= (lead.status || 'new').charAt(0).toUpperCase() + (lead.status || 'new').slice(1) %>
                                            </span>
                                        </td>
                                        <td class="actions-cell">
                                            <button class="edit-btn" onclick="openEditModal('<%= lead._id %>')">
                                                Edit
                                            </button>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="empty-state">
                        <p>No leads data available.</p>
                    </div>
                <% } %>
            </div>
        </main>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Lead</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editForm" class="edit-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editName">Name</label>
                        <input type="text" id="editName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhone">Phone</label>
                        <input type="text" id="editPhone" name="phone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editWebsite">Website</label>
                        <input type="url" id="editWebsite" name="website" required>
                    </div>
                    <div class="form-group">
                        <label for="editRating">Rating</label>
                        <input type="number" id="editRating" name="rating" min="0" max="5" step="0.1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editAddress">Address</label>
                    <textarea id="editAddress" name="address" rows="3" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editStatus">Status</label>
                        <select id="editStatus" name="status" required>
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="proposal">Proposal</option>
                            <option value="closed">Closed</option>
                            <option value="lost">Lost</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" name="notes" rows="4" placeholder="Add any notes about this lead..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="save-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let currentLeadId = null;
        const leads = <%- JSON.stringify(leads) %>;
        
        function openEditModal(leadId) {
            currentLeadId = leadId;
            const lead = leads.find(l => l._id === leadId);
            
            if (lead) {
                document.getElementById('editName').value = lead.name || '';
                document.getElementById('editPhone').value = lead.phone || '';
                document.getElementById('editWebsite').value = lead.website || '';
                document.getElementById('editAddress').value = lead.address || '';
                document.getElementById('editRating').value = lead.rating || '';
                document.getElementById('editStatus').value = lead.status || 'new';
                document.getElementById('editNotes').value = lead.notes || '';
            }
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentLeadId = null;
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        }
        
        // Handle form submission
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentLeadId) return;
            
            const formData = new FormData(this);
            const leadData = {
                _id: currentLeadId,
                name: formData.get('name'),
                phone: formData.get('phone'),
                website: formData.get('website'),
                address: formData.get('address'),
                rating: parseFloat(formData.get('rating')),
                status: formData.get('status'),
                notes: formData.get('notes'),
                createdAt: leads.find(l => l._id === currentLeadId)?.createdAt
            };
            
            try {
                const response = await fetch(`/api/leads/update/${currentLeadId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(leadData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message and reload page
                    alert('Lead updated successfully!');
                    window.location.reload();
                } else {
                    alert('Error updating lead: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating lead. Please try again.');
            }
        });
        
        function filterLeads() {
            const statusFilter = document.getElementById('statusFilter').value;
            const currentUrl = new URL(window.location);
            
            if (statusFilter === 'all') {
                currentUrl.searchParams.delete('status');
            } else {
                currentUrl.searchParams.set('status', statusFilter);
            }
            
            window.location.href = currentUrl.toString();
        }
    </script>
</body>
</html>